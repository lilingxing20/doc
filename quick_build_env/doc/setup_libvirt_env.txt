#####################
#      环境部署     #
#####################

1. 配置源
1.1 小端系统源
vim /etc/yum.repos.d/CentOS-Base.repo 
[base]
name=CentOS-$releasever - Base
baseurl=https://mirrors.aliyun.com/centos-altarch/$releasever/os/$basearch/
gpgcheck=0
gpgkey=https://mirrors.aliyun.com/centos/RPM-GPG-KEY-CentOS-7

#released updates 
[updates]
name=CentOS-$releasever - Updates
baseurl=https://mirrors.aliyun.com/centos-altarch/$releasever/updates/$basearch/
gpgcheck=0
gpgkey=https://mirrors.aliyun.com/centos/RPM-GPG-KEY-CentOS-7

#additional packages that may be useful
[extras]
name=CentOS-$releasever - Extras
baseurl=https://mirrors.aliyun.com/centos-altarch/$releasever/extras/$basearch/
gpgcheck=0
gpgkey=https://mirrors.aliyun.com/centos/RPM-GPG-KEY-CentOS-7
enabled=1

#additional packages that extend functionality of existing packages
[centosplus]
name=CentOS-$releasever - Plus
baseurl=https://mirrors.aliyun.com/centos-altarch/$releasever/centosplus/$basearch/
gpgcheck=0
enabled=0
gpgkey=https://mirrors.aliyun.com/centos/RPM-GPG-KEY-CentOS-7

[virt]
name=CentOS-$releasever - virt
baseurl=https://mirrors.aliyun.com/centos-altarch/$releasever/virt/$basearch/kvm-common
gpgcheck=0
gpgkey=https://mirrors.aliyun.com/centos/RPM-GPG-KEY-CentOS-7

[cloud]
name=CentOS-$releasever - virt
baseurl=https://mirrors.aliyun.com/centos-altarch/$releasever/cloud/$basearch/openstack-queens
gpgcheck=0
gpgkey=https://mirrors.aliyun.com/centos/RPM-GPG-KEY-CentOS-7

2. 安装
yum clean all; yum makecache
yum install qemu-kvm-ev
yum install libvirt
yum install virt-install
yum install openvswitch
yum install libguestfs libguestfs-tools

3. 起服务
service libvird restart
systemctl start openvswitch.service
systemctl enable openvswitch.service

4. 检查libguestfs-tools 版本
[root@localhost ~]# guestmount  -V
guestmount 1.36.10rhel=7,release=6.el7_5.2,libvirt
[root@localhost ~]# guestunmount  -V
guestunmount libguestfs 1.36.10
[root@localhost ~]# guestfish  -V
guestfish 1.36.10rhel=7,release=6.el7_5.2,libvirt


5. 配置ovs桥
ovs-vsctl add-br br-pxe
ovs-vsctl add-br br-mgmt
ovs-vsctl add-br br-tenant
ovs-vsctl add-br br-storage

ovs-vsctl add-port br-mgmt enP3p3s0f0

6. 配置网卡文件
[root@localhost ~]# vim /etc/sysconfig/network-scripts/ifcfg-br-mgmt 
# Generated by parse-kickstart
DEVICE=br-mgmt
BOOTPROTO=static
ONBOOT=yes
NM_CONTROLLED=no
IPADDR=172.30.124.204
NETMASK=255.255.255.0
GATEWAY=172.30.124.254
TYPE=OVSBridge
DEVICETYPE=ovs

[root@localhost ~]# vim /etc/sysconfig/network-scripts/ifcfg-enP3p3s0f0
# Generated by parse-kickstart
DEVICE="enP3p3s0f0"
ONBOOT=yes
NM_CONTROLLED=no
TYPE=OVSPort
DEVICETYPE=ovs
OVS_BRIDGE=br-mgmt

## 重启网卡服务
[root@localhost ~]# service network restart
[root@localhost ~]# systemctl restart network
[root@localhost ~]# ovs-vsctl show
3610c32c-8395-4953-8a90-b3b1a92bea4a
    Bridge br-pxe
        Port br-pxe
            Interface br-pxe
                type: internal
    Bridge br-tenant
        Port br-tenant
            Interface br-tenant
                type: internal
    Bridge br-mgmt
        Port br-mgmt
            Interface br-mgmt
                type: internal
        Port "enP3p3s0f0"
            Interface "enP3p3s0f0"
    Bridge br-storage
        Port br-storage
            Interface br-storage
                type: internal
    ovs_version: "2.9.0"


7. 配置libvirt网络
[root@localhost ~]# vim pxe.xml 
<network> 
  <name>pxe-net</name> 
  <forward mode='bridge'/> <bridge name='br-pxe'/> 
  <virtualport type='openvswitch'/> 
  <portgroup name='vm' default='yes'/>
</network>

[root@localhost ~]# vim mgmt.xml 
<network> 
  <name>mgmt-net</name> 
  <forward mode='bridge'/> <bridge name='br-mgmt'/> 
  <virtualport type='openvswitch'/> 
  <portgroup name='vm' default='yes'/>
</network>

[root@localhost ~]# vim tenant.xml 
<network>
  <name>tenant-net</name>
  <forward mode='bridge'/> <bridge name='br-tenant'/>
  <virtualport type='openvswitch'/>
  <portgroup name='vm' default='yes'/>
</network>

[root@localhost ~]# vim storage.xml 
<network>
  <name>storage-net</name>
  <forward mode='bridge'/> <bridge name='br-storage'/>
  <virtualport type='openvswitch'/>
  <portgroup name='vm' default='yes'/>
</network>


[root@localhost ~]# virsh net-define pxe.xml
[root@localhost ~]# virsh net-autostart pxe-net
[root@localhost ~]# virsh net-start pxe-net
[root@localhost ~]# virsh net-define mgmt.xml
[root@localhost ~]# virsh net-autostart mgmt-net
[root@localhost ~]# virsh net-start mgmt-net
[root@localhost ~]# virsh net-define tenant.xml
[root@localhost ~]# virsh net-autostart tenant-net
[root@localhost ~]# virsh net-start tenant-net
[root@localhost ~]# virsh net-define storage.xml
[root@localhost ~]# virsh net-autostart storage-net
[root@localhost ~]# virsh net-start storage-net
[root@localhost ~]# virsh net-list
 Name                 State      Autostart     Persistent
----------------------------------------------------------
 default              active     yes           yes
 mgmt-net             active     yes           yes
 pxe-net              active     yes           yes
 storage-net          active     yes           yes
 tenant-net           active     yes           yes


8. 配置libvirt存储池
[root@localhost ~]# mkdir /image
[root@localhost ~]# virsh pool-define-as volpool --type dir --target "/image/pool”
[root@localhost ~]# virsh pool-define-as volpool --type dir --target /image/pool
[root@localhost ~]# virsh pool-info volpool
[root@localhost ~]# virsh pool-build volpool
[root@localhost ~]# virsh pool-start volpool
[root@localhost ~]# virsh pool-autostart volpool
[root@localhost ~]# virsh pool-info volpool
[root@localhost ~]# virsh vol-create-as volpool volume1 10G
[root@localhost ~]# ls /image/pool/
volume1


9. 制作镜像
[root@localhost ~]# cd /image/
[root@localhost ~]# wget http://172.30.120.200/isos/centos/ppc64le/CentOS-7-AltArch-ppc64le-Everything-1611.iso
[root@localhost ~]# wget http://172.30.120.200/isos/centos/ppc64le/CentOS-7-AltArch-ppc64le-Everything-1511.iso
[root@localhost ~]# virt-install --connect qemu:///system --name centos74 --virt-type=kvm --memballoon=virtio --vcpus 2 --ram 4096 --disk /image/centos74.qcow2,format=qcow2,bus=virtio,size=80 --network network=pxe-net,model=virtio --network network=mgmt-net,model=virtio --network network=storage-net,model=virtio --network network=tenant-net,model=virtio --vnc --vnclisten=0.0.0.0 --vncport=5901 --os-type=linux --cdrom /image/CentOS-7.4-AltArch-ppc64le-Everything-1708.iso
[root@localhost ~]# virt-install --connect qemu:///system --name centos72 --virt-type=kvm --memballoon=virtio --vcpus 2 --ram 4096 --disk /image/centos72.qcow2,format=qcow2,bus=virtio,size=80 --network network=pxe-net,model=virtio --network network=mgmt-net,model=virtio --network network=storage-net,model=virtio --network network=tenant-net,model=virtio --vnc --vnclisten=0.0.0.0 --vncport=5901 --os-type=linux --cdrom /image/CentOS-7-AltArch-ppc64le-Everything-1511.iso
[root@localhost ~]# virsh list
 Id    Name                           State
----------------------------------------------------
 1     centos72                       running
 2     centos74                       running

通过vncview安装系统
[root@localhost ~]# virsh vncdisplay 1
:0

[root@localhost ~]# virsh vncdisplay 2
:1


#####################
#       Issue:      #
#####################
问题1. [root@localhost shell]# guestmount  -a /home/lixx/openstackha/openstack/ocata/shell/nodeenv/run/image/nodetest/openstack-node-test.qcow2 -m /dev/centos/root --rw /mnt/
libguestfs: error: could not create appliance through libvirt.

Try running qemu directly without libvirt using this environment variable:
export LIBGUESTFS_BACKEND=direct

Original error from libvirt: Cannot access storage file '/home/lixx/openstackha/openstack/ocata/shell/nodeenv/run/image/nodetest/openstack-node-test.qcow2' (as uid:107, gid:107): Permission denied [code=38 int1=13]

解决方法:
export LIBGUESTFS_BACKEND=direct

问题2. ERROR    Cannot access storage file '/home/lixx/openstackha/openstack/ocata/shell/nodeenv/run/image/nodetest/openstack-node-test.qcow2' (as uid:107, gid:107): Permission denied

解决方法:
vim /etc/libvirt/qemu.conf
user = "root"

问题3. ERROR    internal error: qemu unexpectedly closed the monitor: 2018-08-23T06:54:52.690541Z qemu-kvm: -drive file=/home/lixx/openstackha/openstack/ocata/shell/nodeenv/run/image/nodetest/openstack-node-test.qcow2,format=qcow2,if=none,id=drive-virtio-disk0,cache=none: Could not open '/home/lixx/openstackha/openstack/ocata/shell/nodeenv/run/image/nodetest/openstack-node-test.qcow2': Permission denied

解决方法:
chown  -R  root:root /home/lixx/
